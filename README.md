[![CodeFactor](https://www.codefactor.io/repository/github/scattering/sasnets/badge)](https://www.codefactor.io/repository/github/scattering/sasnets)
[![Documentation Status](https://readthedocs.org/projects/sasnets/badge/?version=latest)](https://sasnets.readthedocs.io/en/latest/?badge=latest)
# SASNets

SASNets is a Python program for determining the shape that a SANS (Small Angle Neutron Scattering) dataset of Q and I(Q) comes from. It currently contains two nets: a traditional MLP of 9 layers, and a 1D convolutional network of 11 layers.

SASNets makes use of datafiles generated by a fork of SASModels, found at [pkienzle/sasmodels](https://github.com/pkienzle/sasmodels).

Basic flow:

    # Grab sasnets repo, and sasmodels repo to generate data.
    git clone https://github.com/scattering/sasnets
    git clone https://github.com/pkienzle/sasmodels

    # Create the conda environment.
    # ... probably missing some packages here...
    conda create -n sasnets python numpy scipy matplotlib scikit-learn pandas
    conda activate sasnets
    pip install columnize # ... for pretty output columns [optional]

    # Add tensorflow or tensorflow-gpu, depending on whether you have nvidia
    # hardware (and drivers for cuda 10.0 for tensorflow 2.x).
    #conda install -y tensorflow-gpu
    conda install -y tensorflow

    # Need sasmodels for data generation. This requires pycuda, pyopencl
    # or a C compiler to run.
    conda install -y pybind11 appdirs decorator mako
    pip install pyopencl
    #pip install pycuda
    #pip install tinycc  # small C compiler for windows, if you need it.

    # Work from the sasnets directory
    cd sasnets

    # Generate the table "train" in sasnets.db.  In this case we are
    # only selecting the different types of sphere models.
    bin/sasgen --count=2000 --mono=true *sphere | tee generate.log
    # Use 'all' for the full dataset (600 MB at 2000 items per model).

    # Train on the dataset (you will want to use more epochs...)
    bin/sasnet -v --epochs=10

    # Show training results
    bin/sasanal
    # Show dendrogram
    bin/sasanal -c

On windows, use `python bin/sasgen`, etc.

On nisaba::

    # Setup python environment
    srun -t 60 --pty bash
    module load anaconda
    conda create -n sasnets tensorflow-gpu scikit-learn ipython numpy matplotlib
    exit

    # Run a limited example
    srun --gres=gpu:4 -t 60 --mem=100000 --pty bash
    PYTHONPATH=~/src/sasnets ~/.conda/envs/sasnets/bin/python -m sasnets.sasnet \
    --database /wrk/tbm/sasnets/sasnets.db -v --batch=5000 -s /tmp/sasnets \
    --epochs=10 --limited

    # Run the full fit
    PYTHONPATH=~/src/sasnets ~/.conda/envs/sasnets/bin/python -m sasnets.sasnet \
    --database /wrk/tbm/sasnets/sasnets.db -v --batch=5000 -s /tmp/sasnets \
    --epochs=10

    # Resume the fit
    PYTHONPATH=... -r

    The above command can be put into a batch file and submitted with sbatch.
    Run time is 22s per epoch with 4 GPUs plus 3 min to load the data. So
    running 500 epochs requires --time=180 minutes, or three hours.
